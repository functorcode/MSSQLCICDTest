name: build-pipeline
on: [push]
jobs:
    build:
        runs-on: self-hosted
        steps:
            - name: checkout code
              uses: actions/checkout@v3
            - name: Build now
              run: |
                msbuild -p:Configuration=Release
            # Publish artifact
            - uses: actions/upload-artifact@v3.1.2
              with:
                  name: MSSQLCICDTEST
                  path: ${{ github.workspace }}\MSSQLCICD\bin\Release\
    deploytestenv:
        name: deploy on test enviorment
        needs: [build]
        runs-on: self-hosted
        steps:
            - name: download artifact
              uses: actions/download-artifact@v3.0.2
              with:
                name: MSSQLCICDTEST
            - name: Setup sql action 
              uses: azure/sql-action@v2.2
            - name: Publish package
              run: |
                  sqlpackage
                    /action:Publish
                    /SourceFile:"./MSSQLCICD.dacpac"
                    /TargetDatabaseName:AdventureWorksTestEnv
                    /TargetServerName:"localhost\sqlexpress"